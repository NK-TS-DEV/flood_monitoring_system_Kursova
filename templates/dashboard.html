{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar p-3">
            <h4 class="mb-4 text-center">üåä FloodMonitor</h4>
            <ul class="nav flex-column">
                <li class="nav-item mb-2"><a href="#" class="nav-link active">üìä –î–∞—à–±–æ—Ä–¥</a></li>
                <li class="nav-item mb-2"><a href="#" class="nav-link">üì° –°–µ–Ω—Å–æ—Ä–∏</a></li>
                <li class="nav-item mb-2"><a href="#" class="nav-link">‚ö†Ô∏è –¢—Ä–∏–≤–æ–≥–∏</a></li>
                <li class="nav-item mb-2"><a href="#" class="nav-link">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a></li>
            </ul>
        </div>

        <div class="col-md-10 p-4">
            <h2 class="mb-4">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞ —Å–∏—Ç—É–∞—Ü—ñ—è</h2>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white p-3">
                        <h5>–í—Å—å–æ–≥–æ —Å–µ–Ω—Å–æ—Ä—ñ–≤</h5>
                        <h2>{{ sensors_count }}</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white p-3">
                        <h5>–ê–∫—Ç–∏–≤–Ω—ñ —Ç—Ä–∏–≤–æ–≥–∏</h5>
                        <h2>{{ alerts_count }}</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white p-3">
                        <h5>–°–∏—Å—Ç–µ–º–∞</h5>
                        <h2>Online</h2>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8 mb-4">
                    <div class="card p-3">
                        <h5 class="card-title">–ö–∞—Ä—Ç–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É</h5>
                        <div id="map"></div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card p-3 h-100">
                        <h5 class="card-title text-danger">–û—Å—Ç–∞–Ω–Ω—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h5>
                        <div class="list-group list-group-flush overflow-auto" style="max-height: 450px;">
                            {% for alert in alerts %}
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <strong class="mb-1 text-danger">‚ö†Ô∏è {{ alert.get_level_display }}</strong>
                                    <small>{{ alert.created_at|date:"H:i" }}</small>
                                </div>
                                <p class="mb-1 small">{{ alert.sensor.name }} ({{ alert.sensor.get_region_display }})</p>
                                <small class="text-muted">{{ alert.message }}</small>
                            </div>
                            {% empty %}
                            <p class="text-center text-muted mt-5">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ç—Ä–∏–≤–æ–≥ ‚úÖ</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏ (—Ü–µ–Ω—Ç—Ä –Ω–∞ –ö–∞—Ä–ø–∞—Ç–∞—Ö)
    var map = L.map('map').setView([48.45, 24.55], 9);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // –î–∞–Ω—ñ –∑ Django (JSON)
    var sensorsData = JSON.parse('{{ map_data_json|escapejs }}');

    sensorsData.forEach(function(sensor) {
        var markerColor = sensor.status === 'online' ? 'green' : 'red';
        
        // –ü—Ä–æ—Å—Ç–∏–π –º–∞—Ä–∫–µ—Ä (–º–æ–∂–Ω–∞ –∑–∞–º—ñ–Ω–∏—Ç–∏ –Ω–∞ –∫–æ–ª—å–æ—Ä–æ–≤—ñ —ñ–∫–æ–Ω–∫–∏)
        var marker = L.marker([sensor.lat, sensor.lng]).addTo(map);
        
        marker.bindPopup(`
            <b>${sensor.name}</b><br>
            –†–µ–≥—ñ–æ–Ω: ${sensor.region}<br>
            –ó–Ω–∞—á–µ–Ω–Ω—è: ${sensor.val}<br>
            –°—Ç–∞—Ç—É—Å: ${sensor.status}
        `);
    });
</script>
{% endblock %}